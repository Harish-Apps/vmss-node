#!/bin/bash
set -euo pipefail

# Hard coded Azure details - replace the placeholder values below
AZURE_CLIENT_ID="<client-id>"
AZURE_CLIENT_SECRET="<client-secret>"
AZURE_TENANT_ID="<tenant-id>"
AZURE_SUBSCRIPTION_ID="<subscription-id>"

# Resource group and VMSS configuration
RG="vmss-node-rg"
VMSS="vmss-node"
LOCATION="eastus"

az login --service-principal -u "$AZURE_CLIENT_ID" -p "$AZURE_CLIENT_SECRET" --tenant "$AZURE_TENANT_ID"
az account set --subscription "$AZURE_SUBSCRIPTION_ID"

az group create --name "$RG" --location "$LOCATION"

az vmss create \
  --resource-group $RG \
  --name $VMSS \
  --image UbuntuLTS \
  --admin-username azureuser \
  --generate-ssh-keys \
  --instance-count 2 \
  --vm-sku Standard_DS1_v2 \
  --upgrade-policy-mode automatic \
  --public-ip-per-vm \
  --lb-sku Standard \
  --ports 80

# Run setup on all instances
az vmss run-command invoke \
  --resource-group "$RG" \
  --name "$VMSS" \
  --command-id RunShellScript \
  --scripts @setup_node.sh
